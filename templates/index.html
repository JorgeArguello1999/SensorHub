<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Híbrido: Sensor & OpenWeather</title>

    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        /* Estilos personalizados para el efecto 'glass' */
        .glass-header {
            background-color: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .glass-card {
            background-color: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Estilos para pestañas */
        .tab-button.active {
            border-color: #06b6d4; /* Color cyan-500 */
            color: #06b6d4;
            background-color: rgba(6, 182, 212, 0.1);
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white">

    <div id="temp-dashboard-app">
        <header class="glass-header sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-6 py-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <div class="p-3 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl shadow-lg">
                            <i data-lucide="cloud" class="w-7 h-7 text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-white tracking-tight">Monitor Híbrido: Sensor & Clima</h1>
                            <div class="flex items-center gap-2 mt-1">
                                <i data-lucide="map-pin" class="w-4 h-4 text-cyan-400"></i>
                                <span class="text-cyan-400 text-sm">Ambato, Ecuador</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="last-update" class="text-sm text-slate-400">Esperando datos...</span>
                        <div id="loading-spinner" class="p-2">
                            <i data-lucide="refresh-cw" class="w-4 h-4 text-cyan-400 animate-spin"></i>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-6 py-8">
            <div id="error-message"></div>

            <div id="current-stats-container" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="relative overflow-hidden glass-card rounded-2xl p-6 shadow-2xl hover:shadow-amber-500/10 transition-all group">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-amber-500/5 rounded-full blur-3xl group-hover:bg-amber-500/10 transition-all"></div>
                    <div class="relative">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-amber-500/10 rounded-lg">
                                    <i data-lucide="thermometer-sun" class="w-5 h-5 text-amber-400"></i>
                                </div>
                                <span class="text-sm font-medium text-slate-400">Temp. Local (Sensor)</span>
                            </div>
                            <span class="text-xs text-slate-500 bg-slate-800/50 px-2 py-1 rounded-full">Firebase</span>
                        </div>
                        <div id="temp-local" class="text-5xl font-bold text-white mb-2">--°</div>
                        <div id="weather-desc" class="text-sm text-slate-400">Estado del sensor</div>
                    </div>
                </div>

                <div class="relative overflow-hidden glass-card rounded-2xl p-6 shadow-2xl hover:shadow-emerald-500/10 transition-all group">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-emerald-500/5 rounded-full blur-3xl group-hover:bg-emerald-500/10 transition-all"></div>
                    <div class="relative">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-emerald-500/10 rounded-lg">
                                    <i data-lucide="droplets" class="w-5 h-5 text-emerald-400"></i>
                                </div>
                                <span class="text-sm font-medium text-slate-400">Humedad (Sensor)</span>
                            </div>
                            <span class="text-xs text-slate-500 bg-slate-800/50 px-2 py-1 rounded-full">Firebase</span>
                        </div>
                        <div id="hum-local" class="text-5xl font-bold text-white mb-2">--%</div>
                        <div id="feels-like" class="text-sm text-slate-400">Punto de rocío simulado</div>
                    </div>
                </div>

                <div class="relative overflow-hidden bg-gradient-to-br from-blue-900/40 to-cyan-900/40 backdrop-blur-xl border border-cyan-500/20 rounded-2xl p-6 shadow-2xl hover:shadow-cyan-500/20 transition-all group">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-cyan-500/10 rounded-full blur-3xl group-hover:bg-cyan-500/20 transition-all"></div>
                    <div class="relative">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-cyan-500/20 rounded-lg">
                                    <i data-lucide="cloud-lightning" class="w-5 h-5 text-cyan-400"></i>
                                </div>
                                <span class="text-sm font-medium text-cyan-300">Clima (OpenWeather)</span>
                            </div>
                            <span class="text-xs text-cyan-400 bg-cyan-500/10 px-2 py-1 rounded-full">OpenWeather</span>
                        </div>
                        <div id="ow-main-temp" class="text-3xl font-bold text-white mb-2">--°</div>
                        <div id="ow-main-desc" class="text-sm text-cyan-300/70">--</div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-6 mb-8">
                <div class="bg-slate-800/50 backdrop-blur-xl border border-white/10 rounded-2xl p-6 shadow-2xl">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-white flex items-center gap-2">
                            <div class="w-1 h-6 bg-gradient-to-b from-cyan-500 to-blue-500 rounded-full"></div>
                            Pronóstico Horario (OpenWeather)
                        </h2>
                        <button id="download-csv-button" class="px-3 py-1 bg-slate-700/50 rounded-lg text-sm text-slate-300 hover:bg-slate-700 transition flex items-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Descargar CSV
                        </button>
                    </div>

                    <div class="flex border-b border-slate-700 mb-4">
                        <button id="tab-temp" class="tab-button active px-4 py-2 text-sm font-medium border-b-2 border-transparent hover:border-cyan-500 transition-colors">
                            Temperatura
                        </button>
                        <button id="tab-hum" class="tab-button px-4 py-2 text-sm font-medium border-b-2 border-transparent hover:border-cyan-500 transition-colors">
                            Humedad
                        </button>
                    </div>

                    <div id="chart-temp-container" class="h-[350px]">
                        <canvas id="line-chart-temp"></canvas>
                    </div>
                    <div id="chart-hum-container" class="h-[350px] hidden">
                        <canvas id="line-chart-hum"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-slate-800/50 backdrop-blur-xl border border-white/10 rounded-2xl p-6 shadow-2xl">
                    <h2 class="text-xl font-semibold text-white mb-6 flex items-center gap-2">
                        <div class="w-1 h-6 bg-gradient-to-b from-purple-500 to-pink-500 rounded-full"></div>
                        Pronóstico de 5 Días (cada 3h)
                    </h2>
                    <div id="daily-forecast" class="space-y-3">
                        <div class="text-slate-500">Cargando pronóstico...</div>
                    </div>
                </div>

                <div class="bg-slate-800/50 backdrop-blur-xl border border-white/10 rounded-2xl p-6 shadow-2xl">
                    <h2 class="text-xl font-semibold text-white mb-6 flex items-center gap-2">
                        <div class="w-1 h-6 bg-gradient-to-b from-red-500 to-orange-500 rounded-full"></div>
                        Estadísticas OpenWeather
                    </h2>

                    <div class="space-y-4">
                        <div class="p-4 bg-slate-700/50 rounded-xl">
                            <h3 class="text-sm font-semibold text-slate-400 mb-2">Viento</h3>
                            <p class="text-white text-3xl font-bold" id="ow-wind-speed">-- m/s</p>
                            <p class="text-slate-400 text-sm" id="ow-wind-desc">Última medición OpenWeather</p>
                        </div>
                        <div class="p-4 bg-slate-700/50 rounded-xl">
                            <h3 class="text-sm font-semibold text-slate-400 mb-2">Presión</h3>
                            <p class="text-white text-3xl font-bold" id="ow-pressure">-- hPa</p>
                            <p class="text-slate-400 text-sm" id="ow-pressure-desc">Última medición OpenWeather</p>
                        </div>
                        <div class="p-4 bg-slate-700/50 rounded-xl">
                            <h3 class="text-sm font-semibold text-slate-400 mb-2">Nubes</h3>
                            <p class="text-white text-3xl font-bold" id="ow-clouds">--%</p>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-4">*Datos extraídos del pronóstico actual de OpenWeather.</p>
                </div>
            </div>

        </main>
    </div>

    <script>
        // ======================================================================
        // 1. CONFIGURACIÓN
        // ======================================================================
        
        // --- FIREBASE CONFIG ---
        // ** DEBES REEMPLAZAR ESTO CON TUS CREDENCIALES REALES DE FIREBASE **
        const firebaseConfig = {
            apiKey: "TU_API_KEY_FIREBASE", 
            authDomain: "TU_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://TU_DATABASE_NAME.firebaseio.com",
            projectId: "TU_PROJECT_ID",
            storageBucket: "TU_PROJECT_ID.appspot.com",
            messagingSenderId: "TUS_SENDER_ID",
            appId: "TU_APP_ID"
        };

        // --- OPENWEATHER CONFIG ---
        const API_KEY = "157973ff5bf045a8c66f1b4d7eab78aa"; 
        const CITY_NAME = "Ambato, EC"; // Usaremos la ciudad para el endpoint 2.5
        const UNITS = "metric"; // Celsius
        const LANG = "es";
        
        // ** RUTA DE PRONÓSTICO DE 5 DÍAS / 3 HORAS (Funciona con plan Free) **
        const FORECAST_URL = `https://api.openweathermap.org/data/2.5/forecast?q=${CITY_NAME}&appid=${API_KEY}&units=${UNITS}&lang=${LANG}`;
        
        // ======================================================================
        // 2. INICIALIZACIÓN DE VARIABLES Y LIBRERÍAS
        // ======================================================================

        // Inicializar Firebase (si no lo haces, obtendrás errores de Realtime DB)
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const sensorRef = db.ref('sensor_data'); // Asegúrate de que esta sea la ruta correcta

        let hourlyData = []; 
        let lineChartTempInstance = null;
        let lineChartHumInstance = null;
        
        // Referencias DOM
        const loadingSpinner = document.getElementById('loading-spinner');
        const lastUpdateSpan = document.getElementById('last-update');
        const errorMessageDiv = document.getElementById('error-message');
        const dailyForecastDiv = document.getElementById('daily-forecast');
        
        // Tarjetas
        const tempLocal = document.getElementById('temp-local');
        const humLocal = document.getElementById('hum-local');
        const owMainTemp = document.getElementById('ow-main-temp');
        const owMainDesc = document.getElementById('ow-main-desc');
        const owWindSpeed = document.getElementById('ow-wind-speed');
        const owPressure = document.getElementById('ow-pressure');
        const owClouds = document.getElementById('ow-clouds');

        // ======================================================================
        // 3. FUNCIONES DE UTILIDAD Y RENDERIZADO
        // ======================================================================
        
        const setError = (message) => {
            errorMessageDiv.innerHTML = message
                ? `<div class="bg-red-500/10 border border-red-500/20 text-red-400 px-4 py-3 rounded-xl mb-6 backdrop-blur-sm">${message}</div>`
                : '';
        };

        const getWeatherIcon = (main) => {
            switch (main.toLowerCase()) {
                case 'clear': return 'sun';
                case 'clouds': return 'cloudy';
                case 'rain': return 'cloud-rain';
                case 'drizzle': return 'cloud-drizzle';
                case 'thunderstorm': return 'cloud-lightning';
                case 'snow': return 'cloud-snow';
                default: return 'cloud'; 
            }
        };

        const formatTime = (unix_ts) => {
            return new Date(unix_ts * 1000).toLocaleTimeString('es-EC', { hour: '2-digit', minute: '2-digit' });
        };

        const formatDateTime = (datetime_str) => {
            return new Date(datetime_str).toLocaleTimeString('es-EC', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: 'short' });
        };

        /** Actualiza las tarjetas con los datos del sensor (FIREBASE). */
        const renderSensorStats = (data) => {
            // Asegúrate de que las propiedades coincidan con la estructura de tu sensor
            const temp = data.temperatura || '--';
            const hum = data.humedad || '--';
            const status = data.estado || 'OK'; 
            const timestamp = data.timestamp || Date.now();
            
            tempLocal.textContent = `${parseFloat(temp).toFixed(1)}°`;
            humLocal.textContent = `${parseFloat(hum).toFixed(0)}%`;
            document.getElementById('weather-desc').textContent = `Sensor: ${status}`;
            
            lastUpdateSpan.textContent = `Última lectura: ${new Date(timestamp).toLocaleTimeString()}`;
        };

        /** Actualiza las tarjetas con datos de OpenWeather. */
        const renderOpenWeatherStats = (data) => {
            if (data.list && data.list.length > 0) {
                const current = data.list[0]; // El pronóstico más cercano al momento actual
                
                owMainTemp.textContent = `${current.main.temp.toFixed(1)}°`;
                owMainDesc.textContent = current.weather[0].description.charAt(0).toUpperCase() + current.weather[0].description.slice(1);
                owWindSpeed.textContent = `${current.wind.speed.toFixed(1)} m/s`;
                owPressure.textContent = `${current.main.pressure.toFixed(0)} hPa`;
                owClouds.textContent = `${current.clouds.all.toFixed(0)}%`;
            }
        };

        /** Actualiza la sección de pronóstico (OPENWEATHER). */
        const renderForecast = () => {
            dailyForecastDiv.innerHTML = '';
            
            // Renderiza las primeras 8 entradas (24 horas)
            hourlyData.slice(0, 8).forEach(item => {
                const dateTime = item.dt_txt;
                const iconName = getWeatherIcon(item.weather[0].main);
                
                const itemElement = document.createElement('div');
                itemElement.className = 'flex justify-between items-center bg-slate-700/50 p-3 rounded-lg';
                itemElement.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i data-lucide="${iconName}" class="w-5 h-5 text-cyan-400"></i>
                        <span class="text-sm font-medium">${formatDateTime(dateTime)}</span>
                    </div>
                    <div class="text-sm text-slate-300">${item.weather[0].description}</div>
                    <div class="flex gap-2">
                        <span class="text-white font-bold">${item.main.temp.toFixed(0)}°</span>
                    </div>
                `;
                dailyForecastDiv.appendChild(itemElement);
            });
            
            lucide.createIcons();
        };
        
        // ----------------------------------------------------------------------
        // RENDERIZADO DE GRÁFICOS
        // ----------------------------------------------------------------------
        
        /** Crea o actualiza un gráfico de líneas. */
        const createLineChart = (canvasId, data, key, label, color) => {
            let instance = Chart.getChart(canvasId);
            if (instance) {
                instance.destroy();
            }

            const ctx = document.getElementById(canvasId).getContext('2d');
            const data8Entries = data.slice(0, 8); // Primeras 24 horas (8x3h)

            const chartData = {
                labels: data8Entries.map(d => formatDateTime(d.dt_txt).split(' ')[0]), // Muestra solo la hora
                datasets: [{
                    label: label,
                    data: data8Entries.map(d => d.main[key]),
                    borderColor: color,
                    tension: 0.4,
                    pointRadius: 3,
                    borderWidth: 2,
                    backgroundColor: color + '33' 
                }]
            };

            instance = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { grid: { color: '#3341554d', drawBorder: false }, ticks: { color: '#94a3b8' } },
                        y: { 
                            beginAtZero: false, 
                            title: { display: true, text: label, color: '#94a3b8' },
                            grid: { color: '#3341554d' }, 
                            ticks: { color: '#94a3b8' } 
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
            return instance;
        }

        /** Renderiza los gráficos de tendencia (Temp y Hum de OpenWeather). */
        const renderLineCharts = () => {
            if (hourlyData.length === 0) return; 
            
            // 1. Gráfico de Temperatura
            lineChartTempInstance = createLineChart(
                'line-chart-temp', 
                hourlyData, 
                'temp', 
                'Temperatura (°C)', 
                '#06b6d4' // Cyan
            );
            
            // 2. Gráfico de Humedad
            lineChartHumInstance = createLineChart(
                'line-chart-hum', 
                hourlyData, 
                'humidity', 
                'Humedad (%)', 
                '#10b981' // Emerald
            );
        };

        // ----------------------------------------------------------------------
        // 4. FUNCIONES DE API Y FIREBASE
        // ----------------------------------------------------------------------

        /** Escucha los cambios del sensor en Firebase (tiempo real). */
        const startFirebaseListener = () => {
            // 'value' se dispara una vez inicialmente y luego cada vez que cambian los datos.
            sensorRef.on('value', (snapshot) => {
                loadingSpinner.classList.add('hidden');
                setError(null);
                const data = snapshot.val();
                
                if (data) {
                    renderSensorStats(data);
                } else {
                    setError("Error de Firebase: La ruta 'sensor_data' no tiene datos.");
                }
            }, (errorObject) => {
                console.error("Error al leer datos de Firebase:", errorObject);
                setError(`Error de Firebase: ${errorObject.message}`);
                loadingSpinner.classList.add('hidden');
            });
        };

        /** Obtiene el pronóstico de 5 días / 3 horas de OpenWeather. */
        const fetchOpenWeatherData = async () => {
            // El spinner se maneja en Firebase, solo mostramos el error si falla OW
            
            try {
                const response = await fetch(FORECAST_URL);
                const data = await response.json();

                if (data.cod != "200") { // OpenWeather usa String "200" para esta API
                    throw new Error(`Error ${data.cod}: ${data.message}`);
                }
                
                hourlyData = data.list || []; 
                
                // Actualizar UI
                renderOpenWeatherStats(data);
                renderLineCharts();
                renderForecast();
                
            } catch (error) {
                console.error("Error al obtener datos de OpenWeather:", error);
                setError(`Error de OpenWeather: No se pudo cargar el pronóstico. ${error.message}. (Verifique la API Key o plan)`);
            }
        };


        // ----------------------------------------------------------------------
        // 5. INICIALIZACIÓN
        // ----------------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializa íconos Lucide
            lucide.createIcons();
            
            // Inicia la carga de datos del sensor (Firebase - Tiempo Real)
            startFirebaseListener();
            
            // Inicia la carga de datos del pronóstico (OpenWeather - Cada 5 min)
            fetchOpenWeatherData();
            setInterval(fetchOpenWeatherData, 300000); // Refrescar OW cada 5 minutos

            // --- Event Listener: Descargar CSV ---
            document.getElementById('download-csv-button').addEventListener('click', () => {
                // Función de descarga CSV no implementada en esta versión, usarías hourlyData
                alert("La función de descarga CSV usará los datos de pronóstico de OpenWeather.");
            });

            // --- Event Listeners: Pestañas de Gráficos ---
            const tabTemp = document.getElementById('tab-temp');
            const tabHum = document.getElementById('tab-hum');
            const chartTempContainer = document.getElementById('chart-temp-container');
            const chartHumContainer = document.getElementById('chart-hum-container');
            
            tabTemp.addEventListener('click', () => {
                tabTemp.classList.add('active');
                tabHum.classList.remove('active');
                chartTempContainer.classList.remove('hidden');
                chartHumContainer.classList.add('hidden');
                if(lineChartTempInstance) lineChartTempInstance.resize(); 
            });

            tabHum.addEventListener('click', () => {
                tabHum.classList.add('active');
                tabTemp.classList.remove('active');
                chartHumContainer.classList.remove('hidden');
                chartTempContainer.classList.add('hidden');
                if(lineChartHumInstance) lineChartHumInstance.resize();
            });
        });
    </script>
</body>
</html>
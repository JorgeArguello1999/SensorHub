<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Temperatura Firebase</title>

    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <style>
        .glass-header {
            background-color: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .glass-card {
            background-color: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white">

    <div id="temp-dashboard-app">
        <header class="glass-header sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-6 py-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <div class="p-3 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl shadow-lg">
                            <i data-lucide="thermometer" class="w-7 h-7 text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold text-white tracking-tight">Monitor de Temperatura</h1>
                            <div class="flex items-center gap-2 mt-1">
                                <i data-lucide="map-pin" class="w-4 h-4 text-cyan-400"></i>
                                <span class="text-cyan-400 text-sm">Ambato, Ecuador</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="last-update" class="text-sm text-slate-400">Esperando datos...</span>
                        <div id="loading-spinner" class="p-2">
                            <i data-lucide="refresh-cw" class="w-4 h-4 text-cyan-400 animate-spin"></i>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-6 py-8">
            <div id="error-message"></div>

            <div id="current-stats-container" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="relative overflow-hidden glass-card rounded-2xl p-6 shadow-2xl hover:shadow-amber-500/10 transition-all group">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-amber-500/5 rounded-full blur-3xl group-hover:bg-amber-500/10 transition-all"></div>
                    <div class="relative">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-amber-500/10 rounded-lg">
                                    <i data-lucide="cloud-sun" class="w-5 h-5 text-amber-400"></i>
                                </div>
                                <span class="text-sm font-medium text-slate-400">Temperatura Local</span>
                            </div>
                            <span class="text-xs text-slate-500 bg-slate-800/50 px-2 py-1 rounded-full">OpenWeather</span>
                        </div>
                        <div id="temp-local" class="text-5xl font-bold text-white mb-2">--°</div>
                        <div id="hum-local" class="text-sm text-slate-400">Humedad: --%</div>
                    </div>
                </div>

                <div class="relative overflow-hidden glass-card rounded-2xl p-6 shadow-2xl hover:shadow-emerald-500/10 transition-all group">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-emerald-500/5 rounded-full blur-3xl group-hover:bg-emerald-500/10 transition-all"></div>
                    <div class="relative">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-emerald-500/10 rounded-lg">
                                    <i data-lucide="layout-grid" class="w-5 h-5 text-emerald-400"></i>
                                </div>
                                <span class="text-sm font-medium text-slate-400">Sala</span>
                            </div>
                            <span class="text-xs text-slate-500 bg-slate-800/50 px-2 py-1 rounded-full">Firebase</span>
                        </div>
                        <div id="temp-sala" class="text-5xl font-bold text-white mb-2">--°</div>
                        <div id="hum-sala" class="text-sm text-slate-400">Humedad: --%</div>
                    </div>
                </div>

                <div class="relative overflow-hidden bg-gradient-to-br from-blue-900/40 to-cyan-900/40 backdrop-blur-xl border border-cyan-500/20 rounded-2xl p-6 shadow-2xl hover:shadow-cyan-500/20 transition-all group">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-cyan-500/10 rounded-full blur-3xl group-hover:bg-cyan-500/20 transition-all"></div>
                    <div class="relative">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-cyan-500/20 rounded-lg">
                                    <i data-lucide="home" class="w-5 h-5 text-cyan-400"></i>
                                </div>
                                <span class="text-sm font-medium text-cyan-300">Cuarto</span>
                            </div>
                            <span class="text-xs text-cyan-400 bg-cyan-500/10 px-2 py-1 rounded-full">Firebase</span>
                        </div>
                        <div id="temp-cuarto" class="text-5xl font-bold text-white mb-2">--°</div>
                        <div id="hum-cuarto" class="text-sm text-cyan-300/70">Humedad: --%</div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-6 mb-8">
                <div class="bg-slate-800/50 backdrop-blur-xl border border-white/10 rounded-2xl p-6 shadow-2xl">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-white flex items-center gap-2">
                            <div class="w-1 h-6 bg-gradient-to-b from-cyan-500 to-blue-500 rounded-full"></div>
                            Comparación de Datos (Últimas 12 horas)
                        </h2>
                        <button id="download-csv-button" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-cyan-300 rounded-lg text-sm transition-all flex items-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i> Descargar CSV
                        </button>
                    </div>

                    <div class="flex border-b border-slate-700 mb-6">
                        <button 
                            id="tab-temperatura"
                            data-tab="temperatura"
                            class="tab-button py-2 px-4 text-sm font-medium border-b-2 border-cyan-500 text-cyan-400 transition-colors"
                        >
                            Temperatura (°C)
                        </button>
                        <button 
                            id="tab-humedad"
                            data-tab="humedad"
                            class="tab-button py-2 px-4 text-sm font-medium border-b-2 border-transparent text-slate-400 hover:text-slate-300 transition-colors"
                        >
                            Humedad (%)
                        </button>
                    </div>

                    <div id="chart-content">
                        <div class="h-[350px]">
                            <canvas id="comparison-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-slate-800/50 backdrop-blur-xl border border-white/10 rounded-2xl p-6 shadow-2xl">
                    <h2 class="text-xl font-semibold text-white mb-6 flex items-center gap-2">
                        <div class="w-1 h-6 bg-gradient-to-b from-purple-500 to-pink-500 rounded-full"></div>
                        Comparación por Fecha
                    </h2>
                    <div class="flex gap-4 mb-4 flex-wrap">
                        <div>
                            <label class="block text-sm font-medium text-slate-400 mb-1">Fecha 1</label>
                            <input type="date" id="date1-input" class="bg-slate-700 text-white rounded p-2 focus:ring-cyan-500 focus:border-cyan-500 border-none" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-400 mb-1">Fecha 2</label>
                            <input type="date" id="date2-input" class="bg-slate-700 text-white rounded p-2 focus:ring-cyan-500 focus:border-cyan-500 border-none" />
                        </div>
                        <button id="compare-button" class="mt-6 px-4 py-2 bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-lg hover:from-blue-500 hover:to-cyan-500 transition-all shadow-lg">
                            Comparar
                        </button>
                    </div>
                    <div class="h-[250px] mt-4">
                        <canvas id="historical-chart"></canvas>
                    </div>
                </div>

                <div class="bg-slate-800/50 backdrop-blur-xl border border-white/10 rounded-2xl p-6 shadow-2xl">
                    <h2 class="text-xl font-semibold text-white mb-6 flex items-center gap-2">
                        <div class="w-1 h-6 bg-gradient-to-b from-red-500 to-orange-500 rounded-full"></div>
                        Predicciones (Próximas Horas)
                    </h2>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-400 mb-1">Fecha Base (Hoy)</label>
                        <input type="date" id="prediction-date" class="bg-slate-700 text-white rounded p-2 focus:ring-cyan-500 focus:border-cyan-500 border-none w-full" disabled />
                        <button id="predict-button" class="mt-2 w-full px-4 py-2 bg-gradient-to-r from-orange-600 to-red-600 text-white rounded-lg hover:from-orange-500 hover:to-red-500 transition-all">
                            Generar Predicción
                        </button>
                    </div>

                    <div id="prediction-results" class="space-y-3">
                        <p class="text-sm text-slate-500 text-center py-4">Presiona "Generar Predicción" para ver el pronóstico.</p>
                    </div>
                    
                    <p class="text-xs text-slate-500 mt-4">*Predicción basada en promedios históricos y tendencias simples.</p>
                </div>
            </div>
            
        </main>
    </div>

    <script>
        // ----------------------------------------------------------------------
        // CONFIGURACIÓN FIREBASE
        // ----------------------------------------------------------------------
        const firebaseConfig = {
            databaseURL: "https://esp32-firebase-69994-default-rtdb.firebaseio.com/",
        };

        let app;
        try {
            app = firebase.initializeApp(firebaseConfig);
        } catch (e) {
            console.error("Error al inicializar Firebase.", e);
        }
        const db = app.database();
        const dataRef = db.ref('/');

        // ----------------------------------------------------------------------
        // CONFIGURACIÓN OPENWEATHERMAP
        // ----------------------------------------------------------------------
        const OPENWEATHER_API_KEY = "157973ff5bf045a8c66f1b4d7eab78aa";
        const LATITUDE = -1.274420; 
        const LONGITUDE = -78.638786; 
        const OPENWEATHER_URL = `https://api.openweathermap.org/data/2.5/weather?lat=${LATITUDE}&lon=${LONGITUDE}&APPID=${OPENWEATHER_API_KEY}`;


        // ----------------------------------------------------------------------
        // VARIABLES GLOBALES
        // ----------------------------------------------------------------------
        let realtimeData = {
            local: { temperatura: null, humedad: null }, 
            sala: { temperatura: 0, humedad: 0 },
            cuarto: { temperatura: 0, humedad: 0 }
        };
        let historicalData = []; 
        let comparisonChartInstance = null;
        let historicalChartInstance = null;
        let currentChartDataType = 'temperatura'; // NUEVA variable para controlar la pestaña activa

        // Referencias DOM
        const loadingSpinner = document.getElementById('loading-spinner');
        const lastUpdateSpan = document.getElementById('last-update');
        const errorMessageDiv = document.getElementById('error-message');
        const downloadCsvButton = document.getElementById('download-csv-button'); 
        const tabButtons = document.querySelectorAll('.tab-button'); // NUEVO: botones de pestaña

        // Tarjetas y el resto de los elementos DOM... (sin cambios)
        const tempLocal = document.getElementById('temp-local');
        const humLocal = document.getElementById('hum-local');
        const tempSala = document.getElementById('temp-sala');
        const humSala = document.getElementById('hum-sala');
        const tempCuarto = document.getElementById('temp-cuarto');
        const humCuarto = document.getElementById('hum-cuarto');

        const date1Input = document.getElementById('date1-input');
        const date2Input = document.getElementById('date2-input');
        const compareButton = document.getElementById('compare-button');
        const predictionDate = document.getElementById('prediction-date');
        const predictButton = document.getElementById('predict-button');
        const predictionResultsDiv = document.getElementById('prediction-results'); 

        // ----------------------------------------------------------------------
        // FUNCIONES DE UTILIDAD
        // ----------------------------------------------------------------------
        const setError = (message) => {
            errorMessageDiv.innerHTML = message
                ? `<div class="bg-red-500/10 border border-red-500/20 text-red-400 px-4 py-3 rounded-xl mb-6 backdrop-blur-sm">${message}</div>`
                : '';
        };

        const generateHistoricalData = () => {
            const data = [];
            const now = new Date();
            // Simular las últimas 12 horas
            for (let i = 11; i >= 0; i--) {
                const time = new Date(now.getTime() - i * 3600000);
                const localTemp = realtimeData.local.temperatura ?? 15; 
                const localHum = realtimeData.local.humedad ?? 60; 

                data.push({
                    hora: time.toLocaleTimeString('es-EC', { hour: '2-digit', minute: '2-digit' }),
                    
                    // Almacenamos ambos valores para que el gráfico los use.
                    Local_Temp: localTemp + (Math.random() * 2 - 1),
                    Sala_Temp: realtimeData.sala.temperatura + (Math.random() * 2 - 1),
                    Cuarto_Temp: realtimeData.cuarto.temperatura + (Math.random() * 2 - 1),
                    
                    Local_Hum: localHum + (Math.random() * 5 - 2.5),
                    Sala_Hum: realtimeData.sala.humedad + (Math.random() * 5 - 2.5),
                    Cuarto_Hum: realtimeData.cuarto.humedad + (Math.random() * 5 - 2.5),
                });
            }
            return data;
        };

        const generateMockHistoryForDate = () => {
            // Datos simulados para la comparación histórica
            const data = [];
            for (let h = 0; h < 24; h++) {
                data.push({
                    hora: `${h.toString().padStart(2, '0')}:00`,
                    Local: 18 + Math.random() * 5,
                    Sala: 19 + Math.random() * 4,
                    Cuarto: 20 + Math.random() * 3
                });
            }
            return data;
        };
        
        // Función de API (sin cambios)
        const fetchOpenWeatherMapData = async () => {
            try {
                const response = await fetch(OPENWEATHER_URL);
                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                const data = await response.json();
                const tempKelvin = data.main.temp;
                const tempCelsius = tempKelvin - 273.15;
                const humidity = data.main.humidity;
                return { temperatura: tempCelsius, humedad: humidity };
            } catch (error) {
                setError(`Error al obtener datos de OpenWeatherMap: ${error.message}`);
                console.error("OpenWeatherMap Fetch Error:", error);
                return null;
            }
        };


        // ----------------------------------------------------------------------
        // RENDERIZADO DE UI
        // ----------------------------------------------------------------------
        const renderCurrentStats = () => {
            // Actualizar la tarjeta Local (OpenWeatherMap)
            const localTemp = realtimeData.local.temperatura;
            const localHum = realtimeData.local.humedad;

            tempLocal.textContent = localTemp !== null ? `${localTemp.toFixed(1)}°` : '--°';
            humLocal.textContent = localHum !== null ? `Humedad: ${localHum.toFixed(1)}%` : 'Humedad: --%';
            
            // Actualizar las tarjetas de Firebase
            tempSala.textContent = `${realtimeData.sala.temperatura.toFixed(1)}°`;
            humSala.textContent = `Humedad: ${realtimeData.sala.humedad.toFixed(1)}%`;
            
            tempCuarto.textContent = `${realtimeData.cuarto.temperatura.toFixed(1)}°`;
            humCuarto.textContent = `Humedad: ${realtimeData.cuarto.humedad.toFixed(1)}%`;
        };
        
        /**
         * Renderiza el gráfico de comparación (Líneas) basado en el tipo de dato.
         * @param {Array} data - Datos históricos.
         * @param {string} dataType - 'temperatura' o 'humedad'.
         */
        const renderComparisonChart = (data, dataType) => {
            if (comparisonChartInstance) {
                comparisonChartInstance.destroy();
            }

            const isTemperature = dataType === 'temperatura';
            const unit = isTemperature ? '°C' : '%';
            const dataSuffix = isTemperature ? '_Temp' : '_Hum';
            const labelTitle = isTemperature ? 'Temperatura' : 'Humedad';

            const ctx = document.getElementById('comparison-chart').getContext('2d');
            comparisonChartInstance = new Chart(ctx, {
                type: 'line', 
                data: {
                    labels: data.map(d => d.hora),
                    datasets: [
                        {
                            label: `${labelTitle} Local (Exterior)`,
                            data: data.map(d => d['Local' + dataSuffix]),
                            borderColor: '#fbbf24',
                            tension: 0.4, 
                            fill: false,
                            pointRadius: 3
                        },
                        {
                            label: `${labelTitle} Sala (Firebase)`,
                            data: data.map(d => d['Sala' + dataSuffix]),
                            borderColor: '#10b981',
                            tension: 0.4,
                            fill: false,
                            pointRadius: 3
                        },
                        {
                            label: `${labelTitle} Cuarto (Firebase)`,
                            data: data.map(d => d['Cuarto' + dataSuffix]),
                            borderColor: '#06b6d4',
                            tension: 0.4,
                            fill: false,
                            pointRadius: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { color: '#3341554d' }, ticks: { color: '#94a3b8' } },
                        y: { 
                            beginAtZero: false, 
                            grid: { color: '#3341554d' }, 
                            ticks: { 
                                color: '#94a3b8',
                                callback: function(value) {
                                    return value.toFixed(1) + unit; // Añadir unidad a las etiquetas del eje Y
                                }
                            } 
                        }
                    },
                    plugins: { legend: { labels: { color: '#94a3b8' } } }
                }
            });
        };

        const renderHistoricalChart = (data1, data2, label1, label2) => {
            if (historicalChartInstance) {
                historicalChartInstance.destroy();
            }
            // Mantenemos esta función simple ya que solo tiene datos de temperatura simulados por ahora
            const ctx = document.getElementById('historical-chart').getContext('2d');
            historicalChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data1.map(d => d.hora),
                    datasets: [
                        { label: `Local ${label1}`, data: data1.map(d => d.Local), borderColor: '#fbbf24', borderDash: [0, 0], tension: 0.4, fill: false },
                        { label: `Sala ${label1}`, data: data1.map(d => d.Sala), borderColor: '#10b981', borderDash: [0, 0], tension: 0.4, fill: false },
                        { label: `Cuarto ${label1}`, data: data1.map(d => d.Cuarto), borderColor: '#06b6d4', borderDash: [0, 0], tension: 0.4, fill: false },
                        { label: `Local ${label2}`, data: data2.map(d => d.Local), borderColor: '#fbbf24', borderDash: [5, 5], tension: 0.4, fill: false },
                        { label: `Sala ${label2}`, data: data2.map(d => d.Sala), borderColor: '#10b981', borderDash: [5, 5], tension: 0.4, fill: false },
                        { label: `Cuarto ${label2}`, data: data2.map(d => d.Cuarto), borderColor: '#06b6d4', borderDash: [5, 5], tension: 0.4, fill: false }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { grid: { color: '#3341554d' }, ticks: { color: '#94a3b8' } },
                        y: { 
                            beginAtZero: false, 
                            grid: { color: '#3341554d' }, 
                            ticks: { color: '#94a3b8' } 
                        }
                    },
                    plugins: { legend: { labels: { color: '#94a3b8', boxWidth: 15, padding: 8 } } }
                }
            });
        };

        // ----------------------------------------------------------------------
        // LÓGICA DE PESTAÑAS (NUEVA)
        // ----------------------------------------------------------------------
        const switchTab = (dataType) => {
            currentChartDataType = dataType;
            
            // 1. Manejar estilos de los botones
            tabButtons.forEach(button => {
                if (button.dataset.tab === dataType) {
                    button.classList.add('border-cyan-500', 'text-cyan-400');
                    button.classList.remove('border-transparent', 'text-slate-400', 'hover:text-slate-300');
                } else {
                    button.classList.remove('border-cyan-500', 'text-cyan-400');
                    button.classList.add('border-transparent', 'text-slate-400', 'hover:text-slate-300');
                }
            });
            
            // 2. Renderizar el gráfico con los datos correspondientes
            if (historicalData.length > 0) {
                renderComparisonChart(historicalData, dataType);
            }
        };


        // ----------------------------------------------------------------------
        // FUNCIÓN DE DESCARGA CSV (MODIFICADA para incluir Humedad)
        // ----------------------------------------------------------------------
        const downloadCsv = () => {
            if (historicalData.length === 0) {
                alert("No hay datos históricos para descargar.");
                return;
            }

            // 1. Cabeceras del CSV (Añadidas columnas de Humedad)
            const header = "Hora,Local Temp (°C),Local Hum (%),Sala Temp (°C),Sala Hum (%),Cuarto Temp (°C),Cuarto Hum (%)\n";

            // 2. Mapeo de datos
            const csvData = historicalData.map(item => {
                return [
                    item.hora,
                    item.Local_Temp.toFixed(2),
                    item.Local_Hum.toFixed(2),
                    item.Sala_Temp.toFixed(2),
                    item.Sala_Hum.toFixed(2),
                    item.Cuarto_Temp.toFixed(2),
                    item.Cuarto_Hum.toFixed(2)
                ].join(',');
            }).join('\n'); 

            const finalCsv = header + csvData;

            // 3. Crear el blob y forzar la descarga
            const blob = new Blob([finalCsv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            link.setAttribute('href', url);
            link.setAttribute('download', `datos_historicos_temp_hum_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };


        // ----------------------------------------------------------------------
        // FUNCIÓN DE ACTUALIZACIÓN DE OPENWEATHERMAP
        // ----------------------------------------------------------------------
        const updateOpenWeatherMap = async () => {
            const openWeatherData = await fetchOpenWeatherMapData();

            if (openWeatherData) {
                realtimeData.local.temperatura = openWeatherData.temperatura;
                realtimeData.local.humedad = openWeatherData.humedad;
                
                // Si el listener de Firebase ya está activo, no necesitamos llamar a renderCurrentStats,
                // ya que generateHistoricalData se encargará de esto en el próximo tick, 
                // pero lo mantenemos para el caso de una actualización aislada.
                renderCurrentStats(); 
            }
        };


        // ----------------------------------------------------------------------
        // FIREBASE LISTENER 
        // ----------------------------------------------------------------------
        const setupFirebaseListener = () => {
            dataRef.on('value', async (snapshot) => { 
                loadingSpinner.classList.add('hidden');
                
                const data = snapshot.val();

                if (!data) {
                    setError('No hay datos disponibles en Firebase.');
                    renderCurrentStats(); 
                    return;
                }

                // Obtener Datos de Firebase (Sala y Cuarto)
                realtimeData.sala = {
                    temperatura: parseFloat(data.sala?.temperatura || 0),
                    humedad: parseFloat(data.sala?.humedad || 0)
                };
                realtimeData.cuarto = {
                    temperatura: parseFloat(data.cuarto?.temperatura || 0),
                    humedad: parseFloat(data.cuarto?.humedad || 0)
                };
                
                // Actualizar UI y Gráficos
                historicalData = generateHistoricalData(); 

                renderCurrentStats();
                // Renderizar el gráfico con la pestaña actualmente seleccionada
                renderComparisonChart(historicalData, currentChartDataType); 
                lastUpdateSpan.textContent = new Date().toLocaleTimeString('es-EC');
                setError(null);

            }, (error) => {
                loadingSpinner.classList.add('hidden');
                setError(`Error de Firebase: ${error.code}`);
                console.error("Firebase error:", error);
            });
        };

        // ----------------------------------------------------------------------
        // PREDICCIÓN CON HORAS (Sin cambios en lógica)
        // ----------------------------------------------------------------------
        const generatePrediction = () => {
            predictionResultsDiv.innerHTML = '';
            
            const now = new Date();
            let htmlContent = '';

            for (let i = 1; i <= 4; i++) {
                const nextTime = new Date(now.getTime() + i * 3600000);
                const hourLabel = nextTime.toLocaleTimeString('es-EC', { hour: '2-digit', minute: '2-digit' });

                const predLocal = (realtimeData.local.temperatura ?? 15) + (Math.random() * 2 - 1);
                const predSala = realtimeData.sala.temperatura + (Math.random() * 2 - 1);
                const predCuarto = realtimeData.cuarto.temperatura + (Math.random() * 2 - 1);
                
                const predLocalHum = (realtimeData.local.humedad ?? 60) + (Math.random() * 5 - 2.5);
                const predSalaHum = realtimeData.sala.humedad + (Math.random() * 5 - 2.5);
                const predCuartoHum = realtimeData.cuarto.humedad + (Math.random() * 5 - 2.5);
                
                htmlContent += `
                    <div class="p-3 bg-slate-700/50 rounded-lg border border-slate-600/50">
                        <h4 class="text-lg font-bold text-cyan-300 mb-1">${hourLabel}</h4>
                        <div class="grid grid-cols-3 text-sm text-white font-medium">
                            <div>Local: <span class="text-red-400">${predLocal.toFixed(1)}°</span> / ${predLocalHum.toFixed(1)}%</div>
                            <div>Sala: <span class="text-green-400">${predSala.toFixed(1)}°</span> / ${predSalaHum.toFixed(1)}%</div>
                            <div>Cuarto: <span class="text-blue-400">${predCuarto.toFixed(1)}°</span> / ${predCuartoHum.toFixed(1)}%</div>
                        </div>
                    </div>
                `;
            }

            predictionResultsDiv.innerHTML = htmlContent;
        };


        // ----------------------------------------------------------------------
        // INICIALIZACIÓN
        // ----------------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            setupFirebaseListener();
            updateOpenWeatherMap(); 
            setInterval(updateOpenWeatherMap, 60000); 

            // Configurar fechas iniciales
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
            date1Input.value = yesterday;
            date2Input.value = today;
            predictionDate.value = today; 

            // Renderizar comparación inicial (Mock Data)
            const hist1 = generateMockHistoryForDate();
            const hist2 = generateMockHistoryForDate();
            renderHistoricalChart(hist1, hist2, yesterday, today);

            // --- EVENT LISTENERS ---
            
            // Pestañas (Tabs)
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const dataType = button.dataset.tab;
                    switchTab(dataType);
                });
            });
            // Asegurar que se renderice la pestaña inicial de 'temperatura'
            switchTab('temperatura'); 

            // Comparación por Fecha
            compareButton.addEventListener('click', () => {
                const newHist1 = generateMockHistoryForDate();
                const newHist2 = generateMockHistoryForDate();
                renderHistoricalChart(newHist1, newHist2, date1Input.value, date2Input.value);
            });

            // Predicción
            predictButton.addEventListener('click', generatePrediction);

            // Descarga CSV
            downloadCsvButton.addEventListener('click', downloadCsv);
        });
    </script>
</body>
</html>